# UnitBash - 通用CURL测试脚本框架需求文档

## 项目概述

UnitBash是一个通用的CURL测试脚本框架，旨在为API单元测试提供标准化、可复用的bash脚本工具集。该框架可以通过复制的方式快速集成到其他项目中，为开发团队提供统一的API测试解决方案。

## 项目目标

1. **标准化API测试**: 提供统一的CURL测试脚本模板和规范
2. **快速部署**: 支持通过复制方式快速集成到其他项目
3. **广泛兼容**: 支持常见的认证方式和API测试场景
4. **易于维护**: 模块化设计，便于扩展和维护

## 核心功能需求

### 1. 认证支持
- **JWT认证**: 支持Bearer Token认证方式
- **Basic认证**: 支持用户名/密码基础认证
- **API Key认证**: 支持Header或Query参数形式的API Key
- **Session认证**: 支持基于Cookie的会话认证
- **OAuth 2.0**: 支持OAuth 2.0认证流程（可选）

### 2. RESTful API测试
- **HTTP方法支持**: GET、POST、PUT、DELETE、PATCH、HEAD、OPTIONS
- **请求头管理**: 自定义请求头设置和管理
- **参数处理**: 支持Query参数、Path参数、请求体参数
- **响应验证**: HTTP状态码验证、响应体内容验证
- **数据格式支持**: JSON、XML、Form-data、x-www-form-urlencoded

### 3. 文件上传测试
- **单文件上传**: 支持单个文件的上传测试
- **多文件上传**: 支持批量文件上传测试
- **文件类型验证**: 支持文件格式和大小限制测试
- **进度监控**: 上传进度显示（可选）

### 4. 配置管理
- **环境适配**: 支持开发、测试、生产等多环境配置
- **API配置**: 可配置API基础URL、版本、超时等参数
- **认证配置**: 可配置登录URL、字段名、请求格式等
- **响应配置**: 可配置JWT token字段、成功状态码等
- **动态加载**: 支持运行时动态加载不同环境的配置
- **配置验证**: 启动时验证配置完整性和有效性

### 5. 测试数据管理
- **模拟数据**: 提供测试用的模拟数据集
- **数据生成**: 动态生成测试数据的工具函数
- **数据清理**: 测试后的数据清理机制

## 目录结构规范

```
/test                   # 测试根目录
├── /config            # 配置文件目录
│   ├── base.conf      # 基础配置文件
│   ├── dev.conf       # 开发环境配置
│   ├── test.conf      # 测试环境配置
│   ├── prod.conf      # 生产环境配置
│   └── .env.example   # 环境变量示例文件
├── /mock              # 测试模拟数据
│   ├── users.json     # 用户测试数据
│   ├── files/         # 测试用文件
│   └── responses/     # 模拟响应数据
├── /common            # 通用库文件
│   ├── auth.sh        # 认证相关函数
│   ├── data.sh        # 数据处理函数
│   ├── lib.sh         # 通用工具函数
│   ├── http.sh        # HTTP请求封装函数
│   ├── validate.sh    # 响应验证函数
│   └── config.sh      # 配置管理函数
├── /system            # 系统级单元测试
│   ├── test_auth.sh   # 认证相关测试
│   ├── test_user.sh   # 用户管理测试
│   ├── test_role.sh   # 角色权限测试
│   └── test_config.sh # 系统配置测试
├── /modules           # 业务模块测试
│   ├── /user          # 用户模块测试
│   ├── /order         # 订单模块测试
│   └── /product       # 产品模块测试
└── /scripts           # 辅助脚本
    ├── setup.sh       # 环境初始化脚本
    ├── run_all.sh     # 批量执行脚本
    └── cleanup.sh     # 清理脚本
```

## 技术规范

### 1. 脚本规范
- **Shell版本**: 兼容bash 4.0+
- **编码格式**: UTF-8
- **命名规范**: 
  - 文件名使用下划线分隔：`test_user_login.sh`
  - 函数名使用下划线分隔：`send_post_request()`
  - 变量名使用大写：`API_BASE_URL`

### 2. 配置管理

#### 2.1 基础配置
- **API基础配置**:
  - `API_BASE_URL`: API服务器基础URL（如：`https://api.example.com`）
  - `API_VERSION`: API版本号（如：`v1`, `v2`）
  - `API_TIMEOUT`: 请求超时时间（秒）
  - `API_RETRY_COUNT`: 失败重试次数

#### 2.2 认证配置
- **登录端点配置**:
  - `AUTH_LOGIN_URL`: 登录接口URL（如：`/auth/login`）
  - `AUTH_REFRESH_URL`: Token刷新接口URL（如：`/auth/refresh`）
  - `AUTH_LOGOUT_URL`: 登出接口URL（如：`/auth/logout`）

- **登录字段配置**:
  - `AUTH_USERNAME_FIELD`: 用户名字段名（如：`username`, `email`）
  - `AUTH_PASSWORD_FIELD`: 密码字段名（如：`password`）
  - `AUTH_ADDITIONAL_FIELDS`: 额外登录字段（如：`captcha`, `deviceId`）

- **登录请求格式**:
  - `AUTH_CONTENT_TYPE`: 请求内容类型（`application/json`, `application/x-www-form-urlencoded`）
  - `AUTH_METHOD`: 请求方法（默认POST）

#### 2.3 响应格式配置
- **JWT响应格式**:
  - `JWT_TOKEN_FIELD`: JWT token在响应中的字段名（如：`access_token`, `token`, `data.token`）
  - `JWT_REFRESH_FIELD`: 刷新token字段名（如：`refresh_token`）
  - `JWT_EXPIRES_FIELD`: 过期时间字段名（如：`expires_in`, `exp`）
  - `JWT_TOKEN_TYPE`: Token类型（如：`Bearer`, `JWT`）

- **响应状态配置**:
  - `SUCCESS_STATUS_CODES`: 成功状态码列表（如：`200,201,204`）
  - `SUCCESS_RESPONSE_FIELD`: 响应成功标识字段（如：`success`, `status`）
  - `ERROR_MESSAGE_FIELD`: 错误信息字段名（如：`message`, `error`, `msg`）
  - `DATA_FIELD`: 数据字段名（如：`data`, `result`）

#### 2.4 环境配置
- **多环境支持**:
  - `config/dev.conf`: 开发环境配置
  - `config/test.conf`: 测试环境配置
  - `config/prod.conf`: 生产环境配置
  - `ENVIRONMENT`: 当前环境标识

#### 2.5 安全配置
- **敏感信息管理**:
  - 通过环境变量管理敏感信息
  - 支持配置文件加密
  - 密码、Token等不存储在配置文件中

#### 2.6 配置文件结构示例
```bash
# config/base.conf - 基础配置文件
API_BASE_URL="https://api.example.com"
API_VERSION="v1"
API_TIMEOUT=30
API_RETRY_COUNT=3

# 认证配置
AUTH_LOGIN_URL="/auth/login"
AUTH_USERNAME_FIELD="username"
AUTH_PASSWORD_FIELD="password"
AUTH_CONTENT_TYPE="application/json"

# JWT配置
JWT_TOKEN_FIELD="access_token"
JWT_TOKEN_TYPE="Bearer"
JWT_EXPIRES_FIELD="expires_in"

# 响应配置
SUCCESS_STATUS_CODES="200,201,204"
SUCCESS_RESPONSE_FIELD="success"
ERROR_MESSAGE_FIELD="message"
DATA_FIELD="data"
```

### 3. 错误处理
- **异常捕获**: 完善的错误处理机制
- **日志记录**: 详细的测试日志输出
- **失败重试**: 支持失败重试机制

### 4. 输出格式
- **测试报告**: 生成结构化的测试报告
- **状态码**: 明确的退出状态码
- **日志级别**: 支持不同级别的日志输出

## 使用场景

### 1. 项目集成
- 复制整个`/test`目录到目标项目
- 修改配置文件适配项目环境
- 编写项目特定的测试用例

### 2. CI/CD集成
- 支持在持续集成流水线中执行
- 提供标准化的测试报告输出
- 支持测试结果的自动化分析

### 3. 开发调试
- 开发阶段的API接口验证
- 快速的功能测试执行
- 问题定位和调试支持

## 扩展性考虑

### 1. 插件机制
- 支持自定义认证插件
- 支持自定义验证插件
- 支持自定义报告格式插件

### 2. 协议支持
- 预留WebSocket测试支持
- 预留GraphQL测试支持
- 预留gRPC测试支持（通过工具转换）

### 3. 集成能力
- 支持与测试管理工具集成
- 支持与监控系统集成
- 支持与文档系统集成

## 质量要求

### 1. 可靠性
- 脚本执行的稳定性
- 异常情况的处理能力
- 长时间运行的可靠性

### 2. 性能
- 并发执行支持
- 大数据量测试支持
- 资源使用优化

### 3. 可维护性
- 代码结构清晰
- 文档完善
- 版本管理规范

## 交付物

1. **核心框架**: 完整的脚本框架和工具库
2. **示例用例**: 典型使用场景的示例代码
3. **文档**: 使用说明、API文档、最佳实践
4. **模板**: 项目集成模板和配置模板

## 项目阶段

### 第一阶段：核心框架
- 基础目录结构搭建
- 配置管理系统开发
- 核心库函数开发
- JWT认证支持
- 基础RESTful API测试

### 第二阶段：功能完善
- 多种认证方式支持
- 文件上传测试功能
- 响应验证机制
- 测试报告生成

### 第三阶段：优化扩展
- 性能优化
- 插件机制
- 高级功能支持
- 文档完善

## 成功标准

1. **功能完整性**: 满足所有核心功能需求
2. **易用性**: 新项目可在30分钟内完成集成
3. **稳定性**: 测试执行成功率达到99%以上
4. **兼容性**: 支持主流Linux/macOS环境
5. **文档质量**: 提供完整的使用和开发文档

---

*该需求文档将随着项目进展持续更新和完善*